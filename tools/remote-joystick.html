<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WebSocket Joystick</title>
<style>
body {
    font-family: sans-serif;
    background: #222;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
}
#joystick {
    position: relative;
    width: 200px;
    height: 200px;
    background: #444;
    border-radius: 50%;
    touch-action: none;
}
#handle {
    position: absolute;
    width: 60px;
    height: 60px;
    background: #888;
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}
#status {
    margin-top: 20px;
    font-size: 18px;
}
</style>
</head>
<body>

<div id="joystick">
    <div id="handle"></div>
</div>
<div id="status">X: 0, Y: 0</div>

<script>
const container = document.getElementById('joystick');
const handle = document.getElementById('handle');
const statusEl = document.getElementById('status');

let ws = null;
let dragging = false;

// 建立 WebSocket 連線 (改成你的 ESP32 IP 或 wss://)
function connectWS() {
    ws = new WebSocket("ws://192.168.4.1:81"); // 範例 AP mode 位址
    ws.onopen = () => console.log("WebSocket connected");
    ws.onclose = () => console.log("WebSocket closed");
    ws.onerror = err => console.error("WebSocket error:", err);
}

connectWS();

function calcCenter(container, handle) {
    const rect = container.getBoundingClientRect();
    return {
        cx: rect.left + rect.width / 2,
        cy: rect.top + rect.height / 2,
        maxR: (rect.width / 2) - (handle.offsetWidth / 2),
        width: rect.width,
        height: rect.height
    };
}

function updatePosition(e) {
    const p = calcCenter(container, handle);
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    let dx = clientX - p.cx;
    let dy = clientY - p.cy;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist > p.maxR) {
        dx = dx * p.maxR / dist;
        dy = dy * p.maxR / dist;
    }
    handle.style.left = `${50 + (dx / p.width) * 100}%`;
    handle.style.top = `${50 + (dy / p.height) * 100}%`;

    const xVal = Math.round((dx / p.maxR) * 100);
    const yVal = -Math.round((dy / p.maxR) * 100);

    statusEl.textContent = `X: ${xVal}, Y: ${yVal}`;

    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({x: xVal, y: yVal}));
    }
}

function resetHandle() {
    handle.style.left = "50%";
    handle.style.top = "50%";
    statusEl.textContent = `X: 0, Y: 0`;
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({x: 0, y: 0}));
    }
}

// 滑鼠事件
handle.addEventListener("mousedown", e => {
    dragging = true;
    updatePosition(e);
});
document.addEventListener("mousemove", e => {
    if (dragging) updatePosition(e);
});
document.addEventListener("mouseup", () => {
    dragging = false;
    resetHandle();
});

// 觸控事件
handle.addEventListener("touchstart", e => {
    dragging = true;
    updatePosition(e);
}, {passive: false});
document.addEventListener("touchmove", e => {
    if (dragging) updatePosition(e);
}, {passive: false});
document.addEventListener("touchend", () => {
    dragging = false;
    resetHandle();
});
</script>

</body>
</html>
